/*
	ArmA 3 Wasteland
	Code written by Sa-Matra
	Using this code without Sa-Matra's direct permission is forbidden
	
	
	Special build for Dwarden
	
	ESABQIEXHTFRGOFR
*/
#include "hpp\idcs.hpp"
#include "hpp\settings.hpp"
wgudif=wg4e63;wg6wpn={createDialog "Wasteland_Respawn";disableSerialization;private["_0jk","_0ct"];_0jk=uiNamespace getVariable "Wasteland_Respawn";_0jk displayAddEventHandler["KeyDown","_0i = false; if(wgze2p && (_this select 1) == 1) then {_0i = true;}; _0i"];(_0jk displayCtrl wgm99x)ctrlSetText wg4sje;(_0jk displayCtrl wgm99x)ctrlShow!isStreamFriendlyUIEnabled;_0ct=(if(settings_respawnMenuText!="")then{settings_respawnMenuText}else{localize "STR_WL_Dlg_Respawn_Teamspeak"});(_0jk displayCtrl wg3zky)ctrlSetStructuredText parseText _0ct;if(wghrav in(call settings_trustedUIDs))then{(_0jk displayCtrl wg4e63)ctrlShow true;};wgze2p=true;wgou6f=false;wgj1ob=0;wgas6m=0;wgwg7k=0;wgh2bu=[[],[],[],[],[]];wgj1ob call wgp7vn;true spawn wgq9eb;true spawn wgx6lo;};wgp7vn={disableSerialization;private["_0jk"];_0jk=uiNamespace getVariable "Wasteland_Respawn";if(isNil{if(isNull(_0jk))then{nil}else{true}})exitWith{};wgh2bu=[[],[],[],[],[]];for "_i" from 0 to 4 do{(_0jk displayCtrl(wgpj5y+_i))ctrlShow false;(_0jk displayCtrl(wgpj5y+_i))ctrlEnable true;(_0jk displayCtrl(wgac9j+_i))ctrlShow false;(_0jk displayCtrl(wgac9j+_i))ctrlSetText "";(_0jk displayCtrl(wgbh3t+_i))ctrlSetStructuredText parseText "";};(_0jk displayCtrl wgr6f4)ctrlSetStructuredText parseText "";wgj1ob=_this;wgas6m=0;wgwg7k=0;switch(wgj1ob)do{case 0:{(_0jk displayCtrl wg39z9)ctrlSetText(localize "STR_WL_Dlg_Respawn_Text");};case 1:{(_0jk displayCtrl wg39z9)ctrlSetText(format[localize "STR_WL_Dlg_Respawn_TextAir",wgwhzc]);};case 2:{(_0jk displayCtrl wg39z9)ctrlSetText(localize "STR_WL_Dlg_Respawn_TextRadars");};};};wgx6lo={disableSerialization;private["_0nm"];_0jk=uiNamespace getVariable "Wasteland_Respawn";if(isNil{if(isNull(_0jk))then{nil}else{true}})exitWith{};while{!isNull(_0jk)&&wgze2p}do{for "_i" from 0 to(count wgh2bu-1)do{if(count(wgh2bu select _i)>0)then{if((wgh2bu select _i select 2)>0&&(serverTime<(wgh2bu select _i select 2)))then{_0d=(wgh2bu select _i select 2)-serverTime;if(floor(_0d)==0)then{(_0jk displayCtrl(wgac9j+_i))ctrlSetText "";(_0jk displayCtrl(wgac9j+_i))ctrlShow false;(_0jk displayCtrl(wgpj5y+_i))ctrlEnable true;}else{(_0jk displayCtrl(wgac9j+_i))ctrlSetText(_0d call wgc61g);};};};};wgwg7k=serverTime+0.5;waitUntil{serverTime>wgwg7k};};};wgq9eb={disableSerialization;private["_0nm"];_0jk=uiNamespace getVariable "Wasteland_Respawn";if(isNil{if(isNull(_0jk))then{nil}else{true}})exitWith{};while{!isNull(_0jk)&&wgze2p}do{_0dt=[];_0et=[];if(playerSide in[blufor,opfor,independent])then{for "_i" from 0 to(count wgfalm-1)do{_0ft=0;_0gt=0;_0ht=[];_0it=wgfalm select _i;{if((getPosASL _x)in(wgciid select _i))then{if((side _x==playerSide)&&(side _x!=independent||(group _x==group player)))then{_0ft=_0ft+1;_0ht=_0ht+[_x];}else{_0gt=_0gt+1;};};}forEach playableUnits;if(_0ft>=1)then{if(_0gt<=0)then{_0jt=0;for "_j" from 0 to(count wglsnn-1)do{if(wglsnn select _j select 0==_i)exitWith{_0jt=wglsnn select _j select 1;};};_0dt set[count _0dt,[_i,_0ht,_0jt]];}else{_0et set[count _0et,_i];};};};};_0kt=[];if(playerSide in[blufor,opfor,independent])then{{if(vehicle _x!=_x)then{if((vehicle _x)isKindOf "Air")then{if((driver(vehicle _x)==_x)||(isNull(driver(vehicle _x))&&isClass(configFile>>"CfgVehicles">>typeOf(vehicle _x)>>"Turrets">>"CopilotTurret")&&((vehicle _x)turretUnit[0])==_x))then{if(side _x==playerSide&&(playerSide!=independent||(group player==group _x)))then{if((getPosATL(vehicle _x)select 2)>wgwhzc)then{if(((vehicle _x)emptyPositions "cargo")>0)then{_0jt=0;for "_j" from 0 to(count wgyr7r-1)do{if(wgyr7r select _j select 0==_i)exitWith{_0jt=wgyr7r select _j select 1;};};_0kt set[count _0kt,[vehicle _x,crew(vehicle _x),_0jt]];};};};};};};}forEach playableUnits;};_0lt=[];_0mt=[];if(playerSide in[blufor,opfor,independent])then{{if(damage _x<1)then{if(_x getVariable["object_locked",false])then{if(_x call wghhtm)then{if(_x call wg5nm3)then{_0mt pushBack _x;}else{_0nt=(_x getVariable["radar_enabled_at",0])+wg85xa;if(serverTime>=_0nt)then{_0nt=0;};_0lt pushBack[_x,_x call wgz64o,_0nt];};};};};}forEach wgcug3;};{if(playerSide in(_x select 3))then{(_0jk displayCtrl(wg44x5+(_x select 0)))ctrlSetText format["%1%2",(localize(_x select 1)),(if(count(_x select 2)>0)then{format[": %1",count(_x select 2)]}else{""})];};}forEach[[0,"STR_WL_Dlg_Respawn_TabTowns",_0dt,[blufor,opfor,independent]],[1,"STR_WL_Dlg_Respawn_TabAir",_0kt,[blufor,opfor,independent]],[2,"STR_WL_Dlg_Respawn_TabRadars",_0lt,[blufor,opfor,independent]]];_0ot=(switch(wgj1ob)do{case 0:{_0dt};case 1:{_0kt};case 2:{_0lt};});{_0pt=false;for "_i" from 0 to(count wgh2bu-1)do{if((wgh2bu select _i select 0)==(_x select 0))exitWith{_0pt=true;};};if(!_0pt)then{for "_i" from 0 to(count wgh2bu-1)do{if(count(wgh2bu select _i)==0)exitWith{wgh2bu set[_i,_x];};};};}forEach _0ot;for "_i" from 0 to(count wgh2bu-1)do{_0pt=false;_0na=[];{if((wgh2bu select _i select 0)==(_x select 0))exitWith{_0pt=true;_0na=_x;};}forEach _0ot;wgh2bu set[_i,_0na];if(count(_0na)>0)then{_05m=(switch(wgj1ob)do{case 0:{wgfalm select(_0na select 0)select 0};case 1:{getText(configFile>>"CfgVehicles">>typeOf(_0na select 0)>>"displayname")};case 2:{format["%1 %2",localize "STR_WL_Dlg_Respawn_RadarButton",mapGridPosition(_0na select 0)]};default{"Error"};});(_0jk displayCtrl(wgpj5y+_i))ctrlShow true;(_0jk displayCtrl(wgpj5y+_i))ctrlSetText format["%1",_05m];if(count((_0na select 1))>0)then{_05d="";_name="";_name=if(isStreamFriendlyUIEnabled)then{if(player==((_0na select 1)select 0))then{localize "STR_WL_Me"}else{if(group player==group((_0na select 1)select 0))then{localize "STR_WL_Groupmate"}else{localize "STR_WL_Teammate"};};}else{name((_0na select 1)select 0)};if(group((_0na select 1)select 0)==group(player))then{_05d=format["<t color='#55cc55'>%1</t>",_name];}else{_05d=_name;};for "_j" from 1 to(count((_0na select 1))-1)do{_name=if(isStreamFriendlyUIEnabled)then{if(player==((_0na select 1)select _j))then{localize "STR_WL_Me"}else{if(group player==group((_0na select 1)select _j))then{localize "STR_WL_Groupmate"}else{localize "STR_WL_Teammate"};};}else{name((_0na select 1)select _j)};_05d=format["%1, %2",_05d,if(group((_0na select 1)select _j)==group(player))then{format["<t color='#55cc55'>%1</t>",_name]}else{_name}];};(_0jk displayCtrl(wgbh3t+_i))ctrlSetStructuredText parseText format[localize "STR_WL_Dlg_Respawn_Players",_05d];}else{(_0jk displayCtrl(wgbh3t+_i))ctrlSetStructuredText parseText localize "STR_WL_Dlg_Respawn_NoPlayers";};if(_0na select 2>serverTime)then{(_0jk displayCtrl(wgpj5y+_i))ctrlEnable false;(_0jk displayCtrl(wgac9j+_i))ctrlShow true;};}else{(_0jk displayCtrl(wgpj5y+_i))ctrlShow false;(_0jk displayCtrl(wgbh3t+_i))ctrlSetStructuredText parseText "";};};_05d="";switch(wgj1ob)do{case 0:{if(count(_0et)>0)then{_05d=format["%1 %2",localize "STR_WL_Dlg_Respawn_BlockedTextTowns",wgfalm select(_0et select 0)select 0];for "_i" from 1 to(count(_0et)-1)do{_05d=format["%1, %2",_05d,wgfalm select(_0et select _i)select 0];};};};case 2:{if(count(_0mt)>0)then{_05d=format["%1 ",localize "STR_WL_Dlg_Respawn_BlockedTextRadars"];{_05d=_05d+format["%1%2",(if(_forEachIndex==0)then{""}else{", "}),_x call wgz86r];}forEach _0mt;};};};(_0jk displayCtrl wgr6f4)ctrlSetStructuredText parseText _05d;wgas6m=serverTime+1;waitUntil{wgas6m<serverTime};};};wgsnl2={[_this,if(isNil{wgwl8i})then{50}else{30}]call wg5dqb;};wg5dqb={_pos=_this select 0;_0d=_this select 1;1 preloadObject player;_0ge=serverTime+_0d;startLoadingScreen[""];waitUntil{sleep 0.01;progressLoadingScreen(1-((_0ge-serverTime)/_0d));preloadCamera _pos||(serverTime>=_0ge)};_0qt=(1-((_0ge-serverTime)/_0d));_06s=0.001;waitUntil{sleep 0.01;_0qt=(_0qt+_06s)min 1;_06s=_06s*1.5;progressLoadingScreen _0qt;_0qt>=1};progressLoadingScreen 1;sleep 0.1;endLoadingScreen;};wgsum8={if(!wgze2p||wgou6f)exitWith{};wgou6f=true;_pos=switch(worldName)do{case "Altis":{[8705.28,24892.7,0]};case "Chernarus":{[1279,2521,0]};default{[7095,5950,0]};};player setPos _pos;player switchMove "amovpercmstpslowwpstdnon";for "_i" from 4 to 8 do{_i cutFadeOut 0;};wggw5j=false;wg14a5=false;wgze2p=false;wgk7uv=serverTime;closeDialog 0;wgou6f=false;};wg8g7p={if(!wgze2p||wgou6f)exitWith{};wgou6f=true;_0fn=_this;_0ta=0;_0km=[-1,[],0];if(_0fn in[0,1,2,3,4])then{_0ta=wgj1ob;_0km=wgh2bu select _0fn;};if(count(_0km)==0)exitWith{systemChat "Something went wrong"};_0rt="Error";_0st=false;_0tt=getPosATL player;switch(_0ta)do{case 0:{if(serverTime>(_0km select 2))then{_0ut=[];_0vt=[];for "_i" from 0 to count(wgfalm)-1 do{_0it=wgfalm select _i;_0ka=0;_0wt=0;{_01c=getPosASL _x;if((getPosASL _x)in(wgciid select _i))then{if(side _x!=playerSide||(side _x==independent&&group _x!=group player))then{_0ka=_0ka+1;if(side _x==independent)then{_0wt=_0wt+1;};};};}forEach playableUnits;_0ut set[count _0ut,_0ka];_0vt set[count _0vt,_0wt];};_0rd=-1;_0xt=_0km select 0;if(_0xt>=0&&_0xt<(count wgfalm))then{_0rd=_0xt;_0yt=count wglsnn;for "_i" from 0 to(count wglsnn-1)do{if((wglsnn select _i select 0)==_0rd)exitWith{_0yt=_i;};};wglsnn set[_0yt,[_0rd,serverTime+wg7ysh]];_0zt=[];{if(_x select 1>serverTime)then{_0zt set[count _0zt,_x]};}forEach wglsnn;wgek2k=[0,wghrav,_0zt];publicVariableServer "wgek2k";};private["_0ud"];if(_0rd==-1)then{_01t=[];for "_i" from 0 to(count wgfalm-1)do{if((_0ut select _i<1)&&(wgfalm select _i select 4=="town"))then{_01t set[count _01t,_i];};};if(count _01t>0)then{_0rd=_01t select floor(random(count _01t));}else{if(!isNil "wg9thd")then{_02t=[];{_03t=_x;if({((_04t&&(playerSide!=side _x))||!_04t)&&(_03t distance _x<150)}count playableUnits==0)then{_02t=_02t+[_03t];};}forEach wg9thd;if(count(_02t)==0)then{_0ud=wg9thd select floor(random(count wg9thd));}else{_0ud=_02t select floor(random(count _02t));};_0rd=-1;}else{_0rd=floor(random(count wgfalm));};};};if(_0rd<0)then{player setPos _0ud;player setDir([_0ud,[4000,4000,0]]call BIS_fnc_dirTo);player switchMove "amovpercmstpslowwpstdnon";_0rt=localize "STR_WL_Gen_SomewhereShore";}else{_0wd=wgfalm select _0rd;switch(_0wd select 4)do{case "town":{_pos=[(_0wd select 2),25,65,1,0,0,0]call BIS_fnc_findSafePos;_05t=((_0wd select 2)select 0)-(_pos select 0);_06t=((_0wd select 2)select 1)-(_pos select 1);_pos call wgsnl2;player setPos _pos;player setDir(_05t atan2 _06t);player switchMove "amovpercmstpslowwpstdnon";_0rd call wgskeh;};case "carrier":{};};_0rt=_0wd select 0;};{(group player)reveal _x;}forEach nearestObjects[player,["LandVehicle","ReammoBox"],200];_0st=true;}else{};};case 1:{if(player moveInAny(_0km select 0))then{_0rt=format["%1 (%2)",getText(configFile>>"CfgVehicles">>typeOf(_0km select 0)>>"displayname"),name driver(_0km select 0)];_0st=true;};};case 2:{if((serverTime>(_0km select 2)))then{_0nh=_0km select 0;_0be=getPosATL _0nh;_0be set[2,350+random 100];player setPos _0be;player setDir(random 360);_0rt=format["%1 %2",localize "STR_WL_Dlg_Respawn_RadarButton",mapGridPosition(_0nh)];_0st=true;wgt7bi=[[],[],[],[]];wg1id4=0;}else{};};};if(_0st)then{_07t=serverTime+3;waitUntil{(serverTime>_07t)||(player distance _0tt)>10};player setVelocity[0,0,0];if((player distance _0tt)>10)then{_08t=floor(60*(daytime-floor(daytime)));(format["%1<br/>%2:%4%3",_0rt,floor(daytime),_08t,if(_08t<10)then{"0"}else{""}])spawn BIS_fnc_titleText;wgze2p=false;wgk7uv=serverTime;wg14a5=false;closeDialog 0;}else{hint "Cannot respawn for unknown reason!";};};wgou6f=false;};wgc4gl={scopeName "main";private["_pos","_09t","_0au","_0bu","_0cu","_0du","_0eu","_0gu","_0fu"];_pos=_this select 0;_09t=_this select 1;_0au=_this select 2;_0bu=_this select 3;_0cu=_this select 4;_0du=_this select 5;_0eu=_this select 6;if(_0eu==0)then{_0eu=false}else{_0eu=true};_0fu=[];if((count _this)>7)then{_0fu=_this select 7;};_0gu=[];if((count _this)>8)then{_0gu=_this select 8;};if((count _pos)==0)then{_pos=getArray(configFile>>"CfgWorlds">>worldName>>"safePositionAnchor");};if((count _pos)==0)exitWith{debugLog "Log: [findSafePos] No center position was passed!";[]};if(_0au==-1)then{_0au=getNumber(configFile>>"CfgWorlds">>worldName>>"safePositionRadius");};private["_02l","_0hu","_0iu"];_02l=[];_0hu=_pos select 0;_0iu=_pos select 1;private["_0kb"];_0kb=0;while{_0kb<1000}do{private["_0ju","_0ku","_0lu"];_0ju=_0hu+(_0au-(random(_0au*2)));_0ku=_0iu+(_0au-(random(_0au*2)));_0lu=[_0ju,_0ku];if(!([_0lu,_0fu]call BIS_fnc_isPosBlacklisted))then{if((_pos distance _0lu)>=_09t)then{if(!((count(_0lu isFlatEmpty[_0bu,0,_0du,_0bu max 5,_0cu,_0eu,objNull]))==0))then{_02l=_0lu;breakTo "main";};};};_0kb=_0kb+1;};_02l};wgskeh={_0rd=_this;_0wd=wgfalm select _0rd;_0mu=_0wd select 9;_0nu=0;_0re=(_0wd select 2)nearObjects["LandVehicle",(_0wd select 3)];_0ou=[];_0pu=0;{if(canMove _x)then{if((_x isKindOf "Bicycle")||((fuel _x)>0.05))then{_0nu=_0nu+1;};if((count crew _x)==0&&!(_x isKindOf "Motorcycle"))then{_0dd=weaponCargo _x;if(count(_0dd)==0||(count(_0dd)==1&&([(_0dd select 0),"Pistol"]call wgo3qw)))then{_0ou set[count _0ou,_x];}else{_0pu=_0pu+1;};};};}forEach _0re;if((_0nu<_0mu))then{wghexs=[_0rd,(_0mu-_0nu)];publicVariableServer "wghexs";};if(count(_0ou)>0)then{if((_0pu/(count(_0ou)+_0pu))<0.8)then{wg8pni=[_0rd,_0ou];publicVariableServer "wg8pni";};};};