/*
	ArmA 3 Wasteland
	Code written by Sa-Matra
	Using this code without Sa-Matra's direct permission is forbidden
	
	
	Special build for Dwarden
	
	ESABQIEXHTFRGOFR
*/
#include "hpp\idcs.hpp"
#include "hpp\settings.hpp"
#define wg5pdv	200
#define wgnkn6	100
#define wgnrsj	0.3
#define wg6lx3	1
#define wgnjsd	2.5
#define wgepnu	0
#define wgn31d	1
#define wgjfya			0
#define wg6qmc			1
#define wgejt6		2
#define wgo8ph	3
#define wggfl3		4
#define wghte6	5
#define wga5db		15
"wgcug3" addPublicVariableEventHandler{(_this select 1)call wg6uc6;};wg6uc6={if(typeName _this!=typeName[])then{_this=[_this];};{if(isNull(_x getVariable["radar_location",locationNull]))then{_0qu=createLocation["Name",[0,0,0],wg5pdv,wg5pdv];_0qu attachObject _x;_x setVariable["radar_location",_0qu];};if(_x getVariable["radar_handledamage",-1]<0)then{_x setVariable["radar_handledamage",_x addEventHandler["HandleDamage",{_this call wghr8f}]];};}forEach _this;};wghr8f={_0nh=_this select 0;_0hs=_this select 3;if((player in crew _0hs)&&(_0nh call wghhtm))then{damage _0nh;}else{_this select 2;};};wgfltv={_this setVariable["owner_side",side group player,true];_this setVariable["owner_uid",wghrav,true];wg1rbh=_this;publicVariableServer "wg1rbh";};wgjp56={wg2jnf=wgepnu;wgroje=grpNull;wgusbx=[];wg72pg=objNull;wge9hs=0;wg66o4=0;wgbfl9=false;wgvc4e="";wgmdzv=false;wg5uza=0;wgxzsx=[];wgtb4f=0;wgpata=[];wgfhqi=[];wgygf1=0;wg28ta=0;wg6kad=wgjfya;wgyj5b=0;wgr2q2=getArray(configFile>>"CfgMarkerColors">>(switch(side group player)do{case blufor:{"ColorBLUFOR"};case opfor:{"ColorOPFOR"};case independent:{"ColorIndependent"};default{"ColorCivilian"};})>>"color");{wgr2q2 set[_forEachIndex,call compile _x]}forEach wgr2q2;wgtr6n=+wgr2q2;wgtr6n set[3,(wgtr6n select 3)/2];wgczlj=+wgr2q2;{if(_forEachIndex<3)then{wgczlj set[_forEachIndex,_x/2];};}forEach wgczlj;wgu9or=getText(configFile>>"CfgMarkerBrushes">>"Grid">>"texture");wgfnxk=wgo5td+"i\grp_free.paa";};wgvcg7={switch(wg2jnf)do{case wgepnu:{if(player==player&&!isNil{wgcug3}&&!isNil{wgppw3})then{wg2jnf=wgn31d;wgcug3 call wg6uc6;call wgja88;};};case wgn31d:{if(diag_tickTime>(wge9hs+wgnrsj))then{wge9hs=diag_tickTime;if(isNull(wg72pg))then{if(wg66o4<count(wgcug3))then{_0nh=wgcug3 select wg66o4;if(_0nh call wgyeyb)then{wg72pg=_0nh;wgbfl9=_0nh call wghhtm;wgvc4e=_0nh call wgz86r;wgmdzv=(((_0nh getVariable["radar_enabled_at",0])+wg85xa)>serverTime);wgroje=group player;wgusbx=units group player;call wgsweg;};};wg66o4=wg66o4+1;if(wg66o4>=count(wgcug3))then{wg66o4=0;};}else{if(!(wg72pg call wgyeyb))then{wg72pg=objNull;wgpata=[];wgfhqi=[];call wgja88;};if(group player!=wgroje||!((units group player)isEqualTo wgusbx))then{wgbfl9=wg72pg call wghhtm;call wgja88;call wgbvon;wgroje=group player;wgusbx=units group player;};};};if!(isNull(wg72pg))then{if(wgtb4f>=count wgxzsx)then{call wgsweg;if(wg6kad==wgjfya)then{call wgbvon;};}else{_0cf=wgxzsx select wgtb4f;if(_0cf call wgshbi)then{if!(_0cf in wgpata)then{wgpata pushBack _0cf;wgfhqi pushBack(_0cf call wg76ty);call wgs7t4;};}else{_0e=wgpata find _0cf;if(_0e>=0)then{wgpata deleteAt _0e;wgfhqi deleteAt _0e;if(_0e<wgygf1)then{wgygf1=wgygf1-1;};call wgs7t4;};};wgtb4f=wgtb4f+1;};if(wgygf1>=count wgpata||wgygf1<0)then{wgygf1=0;}else{_0cf=wgpata select wgygf1;_0ru=_0cf call wg76ty;if(switch(true)do{case(!alive _0cf):{true};case!(_0ru isEqualTo(wgfhqi select wgygf1)):{wgfhqi set[wgygf1,_0ru];if((_0cf==player&&!wgbfl9)||!(_0cf call wgr44t))then{call wgs7t4;};false;};default{false};})then{wgpata deleteAt wgygf1;wgfhqi deleteAt wgygf1;call wgs7t4;wgygf1=wgygf1-1;}else{wgygf1=wgygf1+1;};};if(wgmdzv)then{if(wg6kad==wgejt6)then{if(diag_tickTime>(wg5uza+wg6lx3))then{wg5uza=diag_tickTime;wgmdzv=(((wg72pg getVariable["radar_enabled_at",0])+wg85xa)>serverTime);call wgs7t4;};};};if(diag_tickTime>(wg28ta+wgnjsd))then{wg28ta=diag_tickTime;if(switch(true)do{case((wg72pg distance player)<wga5db):{true};case((wg72pg distance positionCameraToWorld[0,0,0])<wga5db):{true};default{false};})then{wg72pg say "WS_Hum";};};};if(wgyj5b!=0&&diag_tickTime>wgyj5b)then{wgyj5b=0;call wginym;};};};};wgsweg={wgxzsx=allUnits;wgtb4f=0;};wgja88={private "_0jk";_0jk=uiNamespace getVariable "Wasteland_Hud";(_0jk displayCtrl wgw2wg)ctrlShow false;wg6kad=wgjfya;};
#define wgzzqv	[0.2,1,0.2,1]
#define wgvgh6	[1,0,0,1]
#define wgljau	[0.2,1,0.2,1]
#define wgd9be	[1,0.2,0.2,1]
#define wgac5k 	"44ff44"
#define wgsk7v		"ff0000"
wgbvon={private "_0jk";_0jk=uiNamespace getVariable "Wasteland_Hud";(_0jk displayCtrl wgw2wg)ctrlShow true;private "_03h";_03h=wg72pg getVariable["owner_side",sideUnknown];(_0jk displayCtrl wgdn9i)ctrlSetText wgvc4e;if(wgbfl9)then{(_0jk displayCtrl wgdcf2)ctrlSetText format[localize "STR_WL_HUD_RadarSideFriendly",localize format["STR_WL_Gen_Team%1_2",_03h]];(_0jk displayCtrl wgdn9i)ctrlSetTextColor wgljau;(_0jk displayCtrl wgwarc)ctrlSetTextColor wgzzqv;}else{(_0jk displayCtrl wgdcf2)ctrlSetText format[localize "STR_WL_HUD_RadarSideEnemy",localize format["STR_WL_Gen_Team%1_2",_03h]];(_0jk displayCtrl wgdn9i)ctrlSetTextColor wgd9be;(_0jk displayCtrl wgwarc)ctrlSetTextColor wgvgh6;};wg6kad=wg6qmc;call wginym;};wgs7t4={if(wgyj5b==0)then{wgyj5b=diag_tickTime+0.1;};};wginym={if(wg6kad==wgjfya)exitWith{};private["_0jk","_0su","_0tu"];_0jk=uiNamespace getVariable "Wasteland_Hud";_0su=0;_0tu=0;{if(_x call wgr44t)then{if(_x!=player)then{_0su=_0su+1;};}else{if!(wgfhqi select _forEachIndex)then{_0tu=_0tu+1;};};}forEach wgpata;if(wgbfl9)then{if(_0tu>0)then{if(wg6kad!=wgo8ph)then{player say "Alarm";};wg6kad=wgo8ph;(_0jk displayCtrl wgwarc)ctrlSetTextColor wgvgh6;(_0jk displayCtrl wgdn9i)ctrlSetTextColor wgvgh6;(_0jk displayCtrl wgy9yo)ctrlSetStructuredText parseText([_0tu call wgnhks,_0su call wg2q4z,localize "STR_WL_HUD_RadarStatus_SpawnsBlocked"]call wgt1xc);}else{wg6kad=wgejt6;(_0jk displayCtrl wgwarc)ctrlSetTextColor wgzzqv;(_0jk displayCtrl wgdn9i)ctrlSetTextColor wgzzqv;(_0jk displayCtrl wgy9yo)ctrlSetStructuredText parseText([localize "STR_WL_HUD_RadarStatus_AllClear",_0su call wg2q4z,wg72pg call wg85sk]call wgt1xc);};}else{if(player call wg76ty)then{wg6kad=wghte6;(_0jk displayCtrl wgy9yo)ctrlSetStructuredText parseText localize "STR_WL_HUD_RadarStatus_YouAreUndetected";}else{wg6kad=wggfl3;(_0jk displayCtrl wgy9yo)ctrlSetStructuredText parseText([localize "STR_WL_HUD_RadarStatus_YouAreDetected",localize "STR_WL_HUD_RadarStatus_EnemySpawnsBlocked"]call wgt1xc);};};};wgnhks={format[(switch(true)do{case(_this<=1):{localize "STR_WL_HUD_RadarStatus_1Enemy"};case(_this>=2&&_this<=4):{localize "STR_WL_HUD_RadarStatus_2to4Enemies"};default{localize "STR_WL_HUD_RadarStatus_5Enemies"};}),_this]};wg2q4z={format[switch(true)do{case(_this<=0):{localize "STR_WL_HUD_RadarStatus_NoFriendlies"};case(_this<=1):{localize "STR_WL_HUD_RadarStatus_1Friendly"};default{localize "STR_WL_HUD_RadarStatus_2Friendlies"};},_this];};wg85sk={private "_0nt";_0nt=(_this getVariable["radar_enabled_at",0])+wg85xa;if(serverTime>=_0nt)exitWith{localize "STR_WL_HUD_RadarStatus_SpawnsAllowed";};format[localize "STR_WL_HUD_RadarStatus_SpawnsIn",(_0nt-serverTime)call wgc61g]};wghhtm={private "_03h";_03h=_this getVariable["owner_side",sideUnknown];if(_03h!=independent&&_03h==side group player)exitWith{true};if(group(_this call wgdtln)==group player)exitWith{true};false;};wgyeyb={if(!alive player)exitWith{false};if(damage _this>=1)exitWith{false};if!(_this getVariable["object_locked",false])exitWith{false};if!((getPosWorld player)in(_this getVariable["radar_location",locationNull]))exitWith{false};if((getPosWorld player select 2)-(getPosWorld _this select 2)>wgnkn6)exitWith{false};true;};wgshbi={if(!alive _this)exitWith{false};if!((getPosWorld _this)in(wg72pg getVariable["radar_location",locationNull]))exitWith{false};if((getPosWorld _this select 2)-(getPosWorld wg72pg select 2)>wgnkn6)exitWith{false};true;};wgn2h2={private["_0cf","_0nh"];_0cf=_this select 0;_0nh=_this select 1;if(!alive _0cf)exitWith{false};if!((getPosWorld _0cf)in(_0nh getVariable["radar_location",locationNull]))exitWith{false};if((getPosWorld _0cf select 2)-(getPosWorld _0nh select 2)>wgnkn6)exitWith{false};true;};wg76ty={if(stance _this=="PRONE")exitWith{true};if(getPosASLW _this select 2<-1.4)exitWith{true};false;};wg5nm3={{if(switch(true)do{case(_x call wgr44t):{false};case(_x call wg76ty):{false};case!([_x,_this]call wgn2h2):{false};default{true};})exitWith{1};}count allUnits>0};wgz64o={private "_0i";_0i=[];{if(_x call wgr44t)then{if([_x,_this]call wgn2h2)then{_0i pushBack _x;};};}forEach allUnits;_0i};wg9ci4={private "_name";_name=_this getVariable["radar_name",[]];if(count _name==0)then{mapGridPosition _this}else{toString _name};};wgz86r={private "_name";_name=_this getVariable["radar_name",[]];if(count _name==0)then{format[localize "STR_WL_Acts_RadarName",mapGridPosition _this]}else{toString _name};};wgbu3w={private["_0hf","_0if"];{if(switch(true)do{case(_x==_this):{false};case(damage _x>=1):{false};case!(_x getVariable["object_locked",false]):{false};default{_0hf=getPosWorld _this;_0hf set[2,0];_0if=getPosWorld _x;_0if set[2,0];(_0hf vectorDistance _0if)<(wg5pdv*2)};})exitWith{1};}count wgcug3>0};wg89p1={{if(damage _x<1)then{if(_x getVariable["object_locked",false])then{if(_x call wghhtm)then{_this drawEllipse[getPosWorld _x,wg5pdv,wg5pdv,0,wgtr6n,wgu9or];_this drawEllipse[getPosWorld _x,wg5pdv,wg5pdv,0,wgr2q2,""];_this drawIcon[wgfnxk,wgr2q2,getPosWorld _x,30,30,0,"",2,0.06,"PuristaMedium","right"];_this drawIcon["#(argb,8,8,3)color(0,0,0,0)",[0.8,0.8,0.8,1],getPosWorld _x,30,30,0,_x call wgz86r,2,0.06,"PuristaMedium","right"];};};};}forEach wgcug3;};